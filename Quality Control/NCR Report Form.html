<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NCR Report Form</title>
  <link rel="stylesheet" href="hrms.css">
  <link rel="stylesheet" href="sty.css">
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">
</head>

<body>

   <form id="ncrForm" action="/ncr/save" method="post" class="form-container"  >
    <!-- Personal Information Section -->
    <input type="hidden"  id="id" name="id" th:value="${ncrList?.id}">
    <div class="form-section active" id="section1">
      <h2>NCR Report Form</h2>

      <!-- First Row -->
    
      <div class="form-row">
        
        <div class="form-group">        
          <label for="department">Department:</label>
          <select id="department" name="department" required>
              <option value="">Select Department</option>
              <option value="Production" th:selected="${ncrList?.department == 'Production'}">Production</option>
              <option value="Warehouse" th:selected="${ncrList?.department == 'Warehouse'}">Warehouse</option>
              <option value="Quality Control" th:selected="${ncrList?.department == 'Quality Control'}">Quality Control</option>
              <option value="Supplier Inspection" th:selected="${ncrList?.department == 'Supplier Inspection'}">Supplier Inspection</option>
          </select>          
        </div>

        <div class="form-group">
          <label class="form-label">Inspection Date</label>
          <input type="date" id="inspectiondate" name="inspectiondate" class="form-control" required th:value="${ncrList?.inspectiondate}">
        </div>

        <div class="form-group">         
					<label for="batchuid">Batch UID:</label>
          <select id="batchuid" name="batchuid" onchange="fetchBatchDetails(this.value)"  required>
              <option value="">Select Batch UID</option>
              <option th:each="uid : ${batchuid}" th:value="${uid}" th:text="${uid}"></option>
          </select>  
        </div>

        <div class="form-group">
          <br>
          <input type="text" id="batchuid" name="batchuid" th:value="${ncrList?.batchuid}" onchange="fetchBatchDetails(this.value)" readonly th:if="${ncrList?.id != null}">
        </div>

        </div>

      <!-- Second Row -->
      <div class="form-row">
        <div class="form-group">
          <label for="productuid">Product ID:</label>
					<input type="text" id="productuid" name="productuid" readonly>
	      </div>
   
        <div class="form-group">
          <label>Item Name:</label>
          <input type="text" id="productname" name="productname" readonly>

        </div>

        <div class="form-group">
          <label class="form-label">Description of Defect</label>
                <input type="text" id="descriptionofdefect" name="descriptionofdefect" class="form-control" required th:text="${ncrList?.descriptionofdefect}"></input>
        </div>

        <div class="form-group" >         
          <label class="form-label">Root Cause Analysis</label>
          <input type="text" id="rootcauseanalysis" name="rootcauseanalysis" class="form-control" required th:text="${ncrList?.rootcauseanalysis}"></input>

        </div>
      </div>
      <!-- Third Row -->
      <div class="form-row">      
          <div class="form-group">            
            <label class="form-label">Defect Severity</label>
            <br>
            <select id="defectseverity" name="defectseverity" class="form-control" required>
                <option value="">Select Defect Severity</option>
                <option value="Minor" th:selected="${ncrList?.defectseverity == 'Minor'}">Minor</option>
                <option value="Major" th:selected="${ncrList?.defectseverity == 'Major'}">Major</option>
                <option value="Critical" th:selected="${ncrList?.defectseverity == 'Critical'}">Critical</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Immediate Action Taken</label>
            <select id="immediateactiontaken" name="immediateactiontaken" class="form-control" required>
                <option value="">Select Action Taken</option>
                <option value="Rework" th:selected="${ncrList?.immediateactiontaken == 'Rework'}">Rework</option>
                <option value="Scrap" th:selected="${ncrList?.immediateactiontaken == 'Scrap'}">Scrap</option>
                <option value="Hold" th:selected="${ncrList?.immediateactiontaken == 'Hold'}">Hold</option>
            </select>
        </div>
        <div class="form-group">
          <label class="form-label">Preventive Action Suggested</label>
          <input type="text"  id="preventiveactionsuggested" name="preventiveactionsuggested" class="form-control" required th:text="${ncrList?.preventiveactionsuggested}"></input>
        </div>

        <div class="form-group">
        <label class="form-label">Approval Status</label>
        <br>
                <select id="approvalstatus" name="approvalstatus" class="form-control" required>
					          <option value="">Select status</option>
                    <option value="Approved" th:selected="${ncrList?.approvalstatus == 'Approved'}">Approved</option>
                    <option value="Pending" th:selected="${ncrList?.approvalstatus == 'Pending'}">Pending</option>
                    <option value="Rejected" th:selected="${ncrList?.approvalstatus == 'Rejected'}">Rejected</option>
                </select> 
          
        </div>
        
      </div>

      <!-- four Row -->

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Supervisor Approval</label>
          <input type="text" id="suppervisorapproval" name="suppervisorapproval" class="form-control" required th:value="${ncrList?.suppervisorapproval}">
        </div>
        
            
       
      
        
    </div>

   <!-- Five Row  -->
  

   </div>  

 


    <div class="form-actions">
      <button type="button" id="submitBtn" class="btn btn-primary w-100" onclick="submitNCRForm()">Submit NCR</button>
			<div th:if="${successMessage}" class="success-message" th:value="${successMessage}"></div>                   
    </div>
  







   </form>
   <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
   <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
   <script>
     


$(document).ready(function() {
     // Auto-fill Item details when updating
     var existingItemid = $('#batchuid').val();
     if (existingItemid) {
       fetchBatchDetails(existingItemid);
     }
 });

function fetchBatchDetails(batchuid) {
       if (!batchuid) return;

       $.ajax({
           url: '/batch/getbatchdetails',
           method: 'GET',
           data: { batchuid: batchuid },
           success: function(response) {
       if(response && response.length > 0) {
         let data = response[0];
         $('#productuid').val(data.productuid || '');
         $('#productname').val(data.productname || '');
     } else {
       alert('No data found for the seleected product.')
     }
     
               },
           error: function() {
               alert('Error fetching Batch details. Please try again.');
           }
       });
   }


     function submitNCRForm() {
         const formData = new FormData(document.getElementById('ncrForm'));
         const id = $('#id').val(); // Ensure correct ID field

         let url, successMessage;

         if (!id) {
             url = '/ncr/save';
             successMessage = 'NCR submitted successfully!';
         } else {
             url = `/ncr/update`; // Use template literal
             successMessage = 'NCR updated successfully!';
         }

         $.ajax({
             url: url,
             type: 'POST',
             data: formData,
             processData: false,
             contentType: false,
             success: function (response) {
                $('message').text(successMessage);
                 resetNCRForm();
                 window.location.href = '/ncrlist';
             },
         error: function (xhr, status, error) {
                     console.error("Error:", xhr.responseText);
                     alert('Error saving NCR. Please try again.');
                 }
         });
     }

     function resetNCRForm() {
         $('#ncrForm')[0].reset();
         $('#id').val('');
        
         $('#submitBtn').text('Submit NCR');
     }

 function prefillNcrForm(data) {
     $('#id').val(data.id);
     $('#ncruid').val(data.ncruid);
     $('#department').val(data.department);
     $('#inspectiondate').val(data.inspectiondate);
     $('#productuid').val(data.productuid);
     $('#batchNumber').val(data.batchNumber);
     $('#descriptionofdefect').val(data.descriptionofdefect);
     $('#rootcauseanalysis').val(data.rootcauseanalysis);
     $('#defectseverity').val(data.defectseverity);
     $('#immediateactiontaken').val(data.immediateactiontaken);
     $('#preventiveactionsuggested').val(data.preventiveactionsuggested);
     $('#approvalstatus').val(data.approvalstatus);
     $('#suppervisorapproval').val(data.suppervisorapproval);
     
     $('#form-title').text('NCR Report Form');
     $('#submitBtn').text('Submit NCR');
 }
 
 
 
 $(document).ready(function () {
     /*** ✅ Validation: Only Allow Alphabets & Spaces in Specific Fields ***/
     function validateTextInput(input) {
         let regex = /^[A-Za-z\s]+$/; // Only letters and spaces
         return regex.test(input);
     }

     $('#department, #itemname, #suppervisorapproval, #descriptionofdefect, #rootcauseanalysis, #preventiveactionsuggested').on('input', function () {
         let inputVal = $(this).val();
         if (!validateTextInput(inputVal)) {
             $(this).val(inputVal.replace(/[^A-Za-z\s]/g, ''));
         }
     });

     /*** ✅ Validate Numeric Fields (Batch Number & Alert Threshold) ***/
     $('#batchnumber, #alertthreshold').on('input', function () {
         let inputVal = $(this).val();
         $(this).val(inputVal.replace(/\D/g, '')); // Allow only numbers
     });

     /*** ✅ Prevent Past Dates for Inspection Date ***/
     $('#inspectiondate').on('change', function () {
         let today = new Date().toISOString().split('T')[0];
         if ($(this).val() < today) {
             alert("⚠ Inspection date cannot be in the past.");
             $(this).val(today);
         }
     });

     /*** ✅ Prevent User from Changing Action Date ***/
     let actionDateInput = $('#actiondate');

     function setTodayDate() {
         let today = new Date().toISOString().split('T')[0]; // Format: YYYY-MM-DD
         actionDateInput.val(today).attr({ "min": today, "max": today });
     }

     setTodayDate(); // Set default value

     actionDateInput.on('keydown', function (event) {
         event.preventDefault(); // Prevent manual input
     }).on('change', function () {
         setTodayDate(); // Reset if user tries to modify manually
     });

     /*** ✅ Form Submission with Validation ***/
     $('#submitBtn').on('click', function (event) {
         event.preventDefault();
         if (validateForm()) {
             $('#ncrForm').submit(); // Submit the form if validation passes
         }
     });

     function validateForm() {
         let isValid = true;

         $('.form-control').each(function () {
             let fieldId = $(this).attr('id');
             let inputVal = $(this).val().trim();

             // Validate text fields
             if ($(this).is('input[type="text"], textarea') && !validateTextInput(inputVal) &&
                 !['descriptionofdefect', 'rootcauseanalysis', 'preventiveactionsuggested'].includes(fieldId)) {
                 alert('⚠ Please enter only letters and spaces in text fields.');
                 isValid = false;
                 return false;
             }

             // Validate required fields
             if ($(this).prop('required') && inputVal === '') {
                 alert(`⚠ The field "${fieldId}" is required.`);
                 isValid = false;
                 return false;
             }
         });

         return isValid;
     }
 });

</Script>






  


</body>
</html>

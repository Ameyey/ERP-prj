<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Non Conformance Report Form</title>
  <link rel="stylesheet" href="hrms.css">
  <link rel="stylesheet" href="sty.css">
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">
</head>

<body>

   <form id="ncrForm"  class="form-container"  >
    <!-- Personal Information Section -->
     	<input type="hidden"  id="id" name="id" th:value="${ncr?.id}">
    <div class="form-section active" id="section1">
      <h2>Non Conformance Report Form</h2>

      <!-- First Row -->
    
      <div class="form-row">
        
        <div class="form-group">        
         <label for="department">Department:</label>
			<select id="department" name="department" required>
			    <option value="">Select Department</option>
			    <option value="Production" th:selected="${ncr?.department == 'Production'}">Production</option>
			    <option value="Warehouse" th:selected="${ncr?.department == 'Warehouse'}">Warehouse</option>
			    <option value="Quality Control" th:selected="${ncr?.department == 'Quality Control'}">Quality Control</option>
			    <option value="Supplier Inspection" th:selected="${ncr?.department == 'Supplier Inspection'}">Supplier Inspection</option>
			</select>
			          
        </div>

        <div class="form-group">
          <label class="form-label">Inspection Date</label>
                <input type="date" id="inspectiondate" name="inspectiondate" class="form-control" required th:value="${ncr?.inspectiondate}">
        </div>

        <div class="form-group">         
					<label for="batchuid">Batch UID:</label>
					<select id="batchuid" name="batchuid" onchange="fetchBatchDetails(this.value)" th:if="${ncr == null or ncr.id == null}" required>
										    <option value="">Select Batch UID</option>
										    <option th:each="uid : ${batchuid}" th:value="${uid}" th:text="${uid}"></option>
										</select>
										<input type="text" id="batchuid" name="batchuid" th:value="${ncr?.batchuid}" onchange="fetchBatchDetails(this.value)" readonly th:if="${ncr?.id != null}">
 
        </div>

        

        </div>

      <!-- Second Row -->
      <div class="form-row">
        <div class="form-group">
          <div class="form-group">
          <label for="productuid">Product ID:</label>
						            <input type="text" id= "productuid" name="productuid" th:value="${ncr?.productuid}"readonly>
						       
        </div>
        </div>
        <div class="form-group">
         <label for="productname">Product Name:</label>
									<input type="text" id="productname" name="productname"  th:value="${ncr?.productname}"readonly>
	      </div>
   
        <div class="form-group">
           <label class="form-label" >Description of Defect</label>
          <textarea  cols="23" id="descriptionofdefect" name="descriptionofdefect" class="form-control" required th:text="${ncr?.descriptionofdefect}"></textarea>
            
        </div>

       
      </div>
      <!-- Third Row -->
      <div class="form-row">  
         <div class="form-group">
             <label class="form-label">Root Cause Analysis</label>
                <textarea   cols="25" id="rootcauseanalysis" name="rootcauseanalysis" class="form-control" required th:text="${ncr?.rootcauseanalysis}"></textarea>
        
           </div>

        <div class="form-group" >         
           <label class="form-label">Defect Severity</label>
                <select id="defectseverity" name="defectseverity" class="form-control" required>
					<option value="">Select Defect Severity</option>
                    <option value="Minor" th:selected="${ncr?.defectseverity == 'Minor'}">Minor</option>
                    <option value="Major" th:selected="${ncr?.defectseverity == 'Major'}">Major</option>
                    <option value="Critical" th:selected="${ncr?.defectseverity == 'Critical'}">Critical</option>
                </select>
        </div>    
          <div class="form-group">            
                            <label class="form-label">Immediate Action Taken</label>
                <select id="immediateactiontaken" name="immediateactiontaken" class="form-control" required>
					<option value="">Select Action Taken</option>
                    <option value="Rework" th:selected="${ncr?.immediateactiontaken == 'Rework'}">Rework</option>
                    <option value="Scrap" th:selected="${ncr?.immediateactiontaken == 'Scrap'}">Scrap</option>
                    <option value="Hold" th:selected="${ncr?.immediateactiontaken == 'Hold'}">Hold</option>
                </select>
          </div>

         
        
      </div>

      <!-- four Row -->
<div class="form-row">
   <div class="form-group">
             <label class="form-label" style="font-size: 13px;">Preventive Action Suggested</label>
                <textarea id="preventiveactionsuggested" cols="25" name="preventiveactionsuggested" class="form-control" required th:text="${ncr?.preventiveactionsuggested}"></textarea>
         
        </div>
        <div class="form-group">
           <label class="form-label">Approval Status</label>
                <select id="approvalstatus" name="approvalstatus" class="form-control" required>
					<option value="">Select status</option>
                    <option value="Approved" th:selected="${ncr?.approvalstatus == 'Approved'}">Approved</option>
                    <option value="Pending" th:selected="${ncr?.approvalstatus == 'Pending'}">Pending</option>
                    <option value="Rejected" th:selected="${ncr?.approvalstatus == 'Rejected'}">Rejected</option>
                </select>
          </div>

        <div class="form-group">
        <label class="form-label">Suppervisor Approval</label>
                <input type="text" id="suppervisorapproval" name="suppervisorapproval" class="form-control" required th:value="${ncr?.suppervisorapproval}">
            
        </div>
</div>
    

   <!-- Five Row  -->
  

   </div>  

 


    <div class="form-actions">
       <button type="button" id="submitBtn" class="btn btn-primary w-100" onclick="submitNCRForm()">Submit NCR</button>
			<div th:if="${successMessage}" class="success-message" th:value="${successMessage}"></div>
     </div>
  







   </form>
   <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script>
				

function fetchBatchDetails(batchuid) {
    if (!batchuid) {
        console.warn("No batch UID provided.");
        return;
    }

    console.log("Fetching batch details for UID:", batchuid);

    $.ajax({
        url: '/batch/getbatchdetails',
        method: 'GET',
        data: { batchuid: batchuid },
        success: function(response) {
            console.log("Server response:", response);

            // Ensure it's an object or array and not null
            if (response) {
                let data = Array.isArray(response) ? response[0] : response;

                // Check if data contains expected fields
                if (data.productuid || data.productname) {
                    $('#productuid').val(data.productuid || '');
                    $('#productname').val(data.productname || '');
                } else {
                    alert('No matching batch data found for UID: ' + batchuid);
                }
            } else {
                alert('Empty response for batch UID: ' + batchuid);
            }
        },
        error: function(xhr, status, error) {
            console.error("AJAX Error:", status, error);
            alert('Error fetching batch details. Please try again.');
        }
    });
}

function validateNCRForm() {
    let isValid = true;
    let errorMessages = [];

    // Trimmed values
    const values = {
        department: $('#department').val().trim(),
        inspectiondate: $('#inspectiondate').val().trim(),
        batchuid: $('#batchuid').val().trim(),
        productname: $('#productname').val().trim(),
        descriptionofdefect: $('#descriptionofdefect').val().trim(),
        rootcauseanalysis: $('#rootcauseanalysis').val().trim(),
        defectseverity: $('#defectseverity').val().trim(),
        immediateactiontaken: $('#immediateactiontaken').val().trim(),
        preventiveactionsuggested: $('#preventiveactionsuggested').val().trim(),
        approvalstatus: $('#approvalstatus').val().trim(),
        suppervisorapproval: $('#suppervisorapproval').val().trim()
    };

    // 1. Check Required Fields
    for (let [field, value] of Object.entries(values)) {
        if (!value) {
            isValid = false;
            errorMessages.push(`${field} is required.`);
        }
    }

    // 2. Validate String-only Fields
    const stringOnlyFields = [
        'department', 
        'productname', 
        'descriptionofdefect', 
        'rootcauseanalysis', 
        'preventiveactionsuggested', 
        'suppervisorapproval'
    ];
    const alphaRegex = /^[A-Za-z\s]+$/;

    stringOnlyFields.forEach(field => {
        const value = values[field];
        if (value && !alphaRegex.test(value)) {
            isValid = false;
            errorMessages.push(`${field} must contain only alphabets and spaces.`);
        }
    });

    // 3. Validate Numeric-only Fields
    const numericOnlyFields = ['batchuid'];
    const numericRegex = /^[0-9]+$/;

    numericOnlyFields.forEach(field => {
        const value = values[field];
        if (value && !numericRegex.test(value)) {
            isValid = false;
            errorMessages.push(`${field} must contain only numbers.`);
        }
    });

    // 4. Show alert if invalid
    if (!isValid) {
        alert("Validation failed:\n" + errorMessages.join("\n"));
    }

    return isValid;
}


				function submitNCRForm() {
				    const formData = new FormData(document.getElementById('ncrForm'));
				    const id = $('#id').val(); // Ensure correct ID field

				    let url, successMessage;

				    if (!id) {
				        url = '/nonconformancereport/save';
				        successMessage = 'NCR submitted successfully!';
				    } else {
				        url = '/nonconformancereport/update'; // Use template literal
				        successMessage = 'NCR updated successfully!';
				    }

				    $.ajax({
				        url: url,
				        type: 'POST',
				        data: formData,
				        processData: false,
				        contentType: false,
				        success: function (response) {
				           $('message').text(successMessage);
				            resetNCRForm();
				            window.location.href = '/nonconformancereport/list';
				        },
						error: function (xhr, status, error) {
						            console.error("Error:", xhr.responseText);
						            alert('Error saving NCR. Please try again.');
						        }
				    });
				}

				function resetNCRForm() {
				    $('#ncrForm')[0].reset();
				    $('#id').val('');
					$('#form-title').text('NCR Report Form');

				    $('#submitBtn').text('Submit NCR');
				}

		function prefillNcrForm(data) {
		    $('#id').val(data.id);
		    $('#ncruid').val(data.ncruid);
		    $('#department').val(data.department);
		    $('#inspectiondate').val(data.inspectiondate);
		    $('#productuid').val(data.productuid);
		    $('#batchNumber').val(data.batchNumber);
		    $('#descriptionofdefect').val(data.descriptionofdefect);
		    $('#rootcauseanalysis').val(data.rootcauseanalysis);
		    $('#defectseverity').val(data.defectseverity);
		    $('#immediateactiontaken').val(data.immediateactiontaken);
		    $('#preventiveactionsuggested').val(data.preventiveactionsuggested);
		    $('#approvalstatus').val(data.approvalstatus);
		    $('#suppervisorapproval').val(data.suppervisorapproval);
		    
		    $('#form-title').text('NCR Report Form');
		    $('#submitBtn').text('Submit NCR');
		}
		
		
		
</Script>  





  


</body>
</html>
